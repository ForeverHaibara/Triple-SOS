<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0">
    <title>Sum of Square</title>
    <style>
    </style>
    <!-- <script src="https://requirejs.org/docs/release/2.3.6/minified/require.js"></script> -->
    <script async src="https://cdn.bootcdn.net/ajax/libs/axios/0.21.1/axios.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>  -->
</head>
<body>
<div id="frontpage" 
style="width: 100%;height: 100%;max-width: 1280px;max-height: 720px;position: absolute; display: flex; background: rgb(240,240,240);">
<div id="frontpageleft" style="width: 24%; margin-right: 0.5%; height: 100%; position: relative; 
    border-right: 2px solid rgb(220,220,220); background: rgb(255,255,255)">
    <!-- <div id="variables" style="width: 100%; height: 28px; text-align: left; display: inline-block;
    background: -webkit-linear-gradient(top, rgb(247,247,247),rgb(234,234,234));
    color: black; vertical-align: middle; border-bottom: 1px solid rgb(216,216,216); font-size: 19px;">
    &nbsp  ·&nbsp Variables</div> -->
    <div id="settings" style="width:100%; height: 30%;">
    <div id="settings_head" style="width: 100%; height: 28px; text-align: left; display: inline-block;
    background: -webkit-linear-gradient(top, rgb(247,247,247),rgb(234,234,234));
    color: black; vertical-align: middle; border-bottom: 1px solid rgb(216,216,216); font-size: 19px;">
    &nbsp  ·&nbsp Settings
    </div>
    <input type="checkbox" id="setting_use_structural_method" checked="checked" style="font-size: 14px; margin-top: 10px; margin-left: 10px;" >&nbsp; Use Structural Method</input>
    </div>
    <div id="advertisement" style="position: absolute; left: 5px; bottom: 2%; text-align: left; vertical-align: baseline; font-size: 12px">
    <!-- <a href = "https://github.com/ForeverHaibara/Triple-SOS">GitHub</a> &nbsp; QQ 875413273 -->
    </div>
</div>

<div id="frontpagemid" style="width: 50%; height: 100%; position: relative">
    <div id="inputs" style="width: 100%; height: 5%; margin-top: 1%">    
        <input type="text" id="input_poly" name="poly" style="border: 1px solid black; border-radius: 8px; 
        width: 99%; height: 100%; padding-left: 1%; font-size: small;" autocomplete="off"
        onkeyup="if(event.keyCode==13) {preprocessInput({findroot: 1});}"></input><br>
        <!-- <input type="submit" value="提交"> -->
    </div>
    <div id="centerscreen" style="width: 100%; height: 90%;margin-top: 1.5%; border-style: solid;border-color: gray;
    background: transparent; ">
        <div id="coeffs" style="width: 100%; height: 100%; position: absolute;">
        </div>
        <div id="polytools" style="position: absolute; bottom: 3%; left: 8px;">
            <div id="polytools_btns" style="margin-bottom: 5%">
                <button type="button" class="btn btn-outline-secondary" id="polytools_rotate" onclick="PolyTools('rotate');">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-clockwise" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
                        <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
                    </svg>
                  <span class="visually-hidden">Button</span>
                </button>
                <button type="button" class="btn btn-outline-secondary" id="polytools_rotate_reflect" onclick="PolyTools('rotate_reflect');">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-counterclockwise" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M8 3a5 5 0 1 1-4.546 2.914.5.5 0 0 0-.908-.417A6 6 0 1 0 8 2v1z"/>
                        <path d="M8 4.466V.534a.25.25 0 0 0-.41-.192L5.23 2.308a.25.25 0 0 0 0 .384l2.36 1.966A.25.25 0 0 0 8 4.466z"/>
                    </svg>
                  <span class="visually-hidden">Button</span>
                </button>
                <button type="button" class="btn btn-outline-secondary" id="polytools_reflect" onclick="PolyTools('reflect');">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-left-right" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M1 11.5a.5.5 0 0 0 .5.5h11.793l-3.147 3.146a.5.5 0 0 0 .708.708l4-4a.5.5 0 0 0 0-.708l-4-4a.5.5 0 0 0-.708.708L13.293 11H1.5a.5.5 0 0 0-.5.5zm14-7a.5.5 0 0 1-.5.5H2.707l3.147 3.146a.5.5 0 1 1-.708.708l-4-4a.5.5 0 0 1 0-.708l4-4a.5.5 0 1 1 .708.708L2.707 4H14.5a.5.5 0 0 1 .5.5z"/>
                    </svg>
                  <span class="visually-hidden">Button</span>
                </button>
                <button type="button" class="btn btn-outline-secondary" id="polytools_factor" onclick="PolyTools('factor');">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-wrench-adjustable" viewBox="0 0 16 16">
                        <path d="M16 4.5a4.492 4.492 0 0 1-1.703 3.526L13 5l2.959-1.11c.027.2.041.403.041.61Z"/>
                        <path d="M11.5 9c.653 0 1.273-.139 1.833-.39L12 5.5 11 3l3.826-1.53A4.5 4.5 0 0 0 7.29 6.092l-6.116 5.096a2.583 2.583 0 1 0 3.638 3.638L9.908 8.71A4.49 4.49 0 0 0 11.5 9Zm-1.292-4.361-.596.893.809-.27a.25.25 0 0 1 .287.377l-.596.893.809-.27.158.475-1.5.5a.25.25 0 0 1-.287-.376l.596-.893-.809.27a.25.25 0 0 1-.287-.377l.596-.893-.809.27-.158-.475 1.5-.5a.25.25 0 0 1 .287.376ZM3 14a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"/>
                    </svg>
                  <span class="visually-hidden">Button</span>
                </button>
            </div>
        </div>
        <div id="rootsinfo" style="position: absolute; right: 7px; bottom: 3%; text-align: right; vertical-align: baseline; font-size: 12px">
        </div>
    </div>
</div>


<div id="frontpageright" style="width: 22%; height: 100%; margin-left: 1.5%;"> 
    <div id="heatmap" style="width: 90%; height: 40%; margin-left: 5%; position:relative;">
    </div>
    <button id="sumofsquare" 
    style="width: 90%; height: 5%; margin-left: 5%; margin-top: 2%; position: relative;
     font-size: small;
     background: linear-gradient(to bottom, rgb(247,247,247),rgb(221,221,221)); 
     border: 1px solid; border-color: rgba(200,200,200); color: rgb(60,60,60)"
     onmouseover="this.style.background = 'linear-gradient(to bottom, rgb(247,247,247),rgb(230,230,230))';
                    this.style.color = 'rgb(0,0,0)';" 
     onmouseleave="this.style.background = 'linear-gradient(to bottom, rgb(247,247,247),rgb(221,221,221))';
                    this.style.color = 'rgb(60,60,60)';" 
     onclick="SumOfSquare();"
    >
    Sum of Square
    </button>


    <div id="tangents" style="width: 96%; height: 20%; margin-left: 2%; margin-top: 4%">    
        <textarea id="input_tangents" style="border: 1px solid black; border-radius: 8px; font-family:'Times New Roman', Times, serif;
        width: 99%; height: 100%; padding-left: 1%; resize: none; font-size: small;" ></textarea>
    </div>
    <div id="outputs" style="width: 96%; height: 25%; margin-left: 2%; margin-top: 6%; ">  
        <div id="output_types" style="width: 99%; height: 20%;">
            <!-- <button id="output_showlatex" style="width:31%;height:100%;margin-left:2%;">LaTeX</button>
            <button id="output_showtxt" style="width:31%;height:100%">txt</button>
            <button id="output_showformatted" style="width:31%;height:100%">formatted</button> -->
            <div id="output_showlatex"  style="width:30%;height:99%;margin-left:3%;display:inline-block;text-align:center;padding-top: 2%;
            color:rgb(41,50,225);border-bottom: 2px solid blue;"
            onclick = "ChangeShowType('latex')" 
            onmouseover="ChangeShowTypeHover('latex',0)" onmouseleave="ChangeShowTypeHover('latex',1)">LaTeX</div>
            <div id="output_showtxt"  style="width:30%;height:99%;display:inline-block;text-align:center;padding-top: 2%;" 
            onclick = "ChangeShowType('txt')" 
            onmouseover="ChangeShowTypeHover('txt',0)" onmouseleave="ChangeShowTypeHover('txt',1)">txt</div>
            <div id="output_showformatted"  style="width:33%;height:99%;display:inline-block;text-align:center;padding-top: 2%;" 
            onclick = "ChangeShowType('formatted')"
            onmouseover="ChangeShowTypeHover('formatted',0)" onmouseleave="ChangeShowTypeHover('formatted',1)">formatted</div>
        </div>
        <textarea id="output_result" style="border: 1px solid black; border-radius: 8px; font-family:'Times New Roman', Times, serif;
        width: 99%; height: 82.5%; padding-left: 1%; margin-top: 3%; resize: none; font-size: small;" readonly="readonly"></textarea>
    </div>
</div>

<div id="shadow" hidden="hidden" style="width: 100%; height: 100%; position: absolute; top: 0px; left: 0px; background: rgba(0,0,0,0.59)">
    <div id="shadow_box" hidden="hidden" style="font-size: 15px; background-color: white; width: 80%; height: 80%; top: 10%; left: 10%; position: absolute;
    border: 2px solid blue; border-radius: 5px; text-align: center;"></div>
</div>
</div>
</body>

<script>
    // initialization
    var sos_poly = '';
    var sos_coeffs = [];
    var sos_deg = 0;
    var sos_results = {latex: '', txt: '', formatted: '', show: 'latex', displaying: 0};
    var sos_work = {num: 0};
    var sos_variables = {names: [], range: [[-5,0,5],[-5,0,5],[-5,0,5]]};


    // heatmap triangle
    var heatmap_grids = [];
    const heatmap_gridsize = 60;
    {
        let heatmap_view = document.getElementById('heatmap');
        const l = 100. / heatmap_gridsize; // length of each samll equilateral triangle 
        const ulx = (50 - l * heatmap_gridsize / 2), uly = (35 - 13 * heatmap_gridsize * l / 45);
        for (let i=0;i<=heatmap_gridsize;++i){
            for (let j=0;j<=heatmap_gridsize-i;++j){
                let heatmap_grid = document.createElement('div')
                heatmap_view.appendChild(heatmap_grid)
                let x = ulx + l*(i+j*2)/2, y = uly + l*i*13/15;
                heatmap_grid.setAttribute('style', 'position:absolute;left:'+x+'%;top:'+y+'%;'
                            +'height:'+l+'%'+';width:'+l+'%;background:white');
                heatmap_grids.push(heatmap_grid);
            }
        }   
    }


    function CreateVariables(){
        const n = sos_variables.names.length; 
        for (let i = 0; i < n; ++i){
            let variable = document.createElement('div');
            document.getElementById('frontpageleft').appendChild(variable);
            variable.setAttribute('style', 'width: 100%; height: 10%;');
            variable.innerHTML = '<br>&nbsp;&nbsp;' + sos_variables.names[i];
            if (i % 2 === 1){
                variable.style.backgroundColor = 'rgb(245,245,245)';
            }else{
                variable.style.backgroundColor = 'rgb(255,255,255)';
            }
        }
    }
    CreateVariables();

    // functions

    function preprocessInput(kwargs){
        const input_poly = document.getElementById('input_poly').value.trim();        
        
        const parse_undefined = (x, y) => {return typeof(x) === 'undefined'? y: x;}
        const findroot = parse_undefined(kwargs['findroot'], 1);
        const sos = parse_undefined(kwargs['sos'], null);
        const factor = parse_undefined(kwargs['factor'], false);

        if (sos_poly === input_poly){
            if ((sos !== null) && (typeof(sos) !== 'undefined')){ 
                //输入没有变化, 但是要求配方
                sos();
            }
            return;
        }
        
        sos_poly = input_poly;
        axios.post('http://127.0.0.1:5000/process/preprocess',
            {poly: input_poly, factor: factor}
        ).then(res => {
            // after obtaining the return
            // n: degree of polynomial
            // txts: coefficients texts
            
            {
                if (res.data.factor.length > 0){
                    // If we have called factorization on the polynomial
                    document.getElementById("input_poly").value = res.data.factor;
                    sos_poly = res.data.factor.trim();
                }
                else if (res.data.cancel.length > 0){
                    // If the input is fraction, then substitude it with the denominator
                    document.getElementById("input_poly").value = res.data.cancel;
                    sos_poly = res.data.cancel.trim();
                }

            }

            // First render the coefficient triangle
            {
                let coeffs_view = document.getElementById('coeffs')
                // if (sos_deg != res.data.n){
                for (let i=sos_coeffs.length-1;i>=0;--i){
                    coeffs_view.removeChild(sos_coeffs.pop());
                }
                // }

                sos_deg = res.data.n ;
                let t = 0;
                const l = 100. / (1 + sos_deg); // length of each samll equilateral triangle 
                const ulx = (50 - l * sos_deg / 2), uly = (29 - 13 * sos_deg * l / 45);
                const fontsize = Math.max(11,Math.floor(28-1.5*sos_deg));
                const lengthscale = .28 * fontsize / 20.;
                const titleparser = (chr, deg) => { 
                    return deg <= 0? '': (deg==1? chr: chr+deg);
                }
                for (let i = 0; i <= sos_deg; ++i){
                    for (let j = 0; j <= i; ++j){
                        let coeff = document.createElement('p');
                        coeffs_view.appendChild(coeff);
                        coeff.innerHTML = res.data.txts[t];
                        let x =  (ulx + l*(2*i-j)/2 - res.data.txts[t].length * lengthscale - 2*Math.floor(res.data.txts[t].length/4)), 
                            y =  (uly + l*j*13/15);
                        coeff.setAttribute('style','position:absolute;left:'+x+'%;top:'+y+'%;font-size:'
                                        +fontsize+'px');
                        // when mouse hover on a monom, it shows hint like 'a5c' for a^5 * c
                        coeff.title = titleparser('a',sos_deg-i) + titleparser('b',i-j) + titleparser('c',j); 
                        coeff.onmouseover = () => {coeff.style.color = 'blue';}
                        if (res.data.txts[t] === '0'){
                            coeff.style.color = 'rgb(180,180,180)';
                            coeff.onmouseout  = () => {coeff.style.color = 'rgb(180,180,180)';}
                        }else{
                            coeff.style.color = 'black';
                            coeff.onmouseout  = () => {coeff.style.color = 'black';}
                        }
                        sos_coeffs.push(coeff)
                        ++t;
                    }
                }
            }
            
            // Next render the heatmap triangle
            {
                let t = 0;
                const color = res.data.heatmap;
                for (let i=0;i<=heatmap_gridsize;++i){
                    for (let j=0;j<=heatmap_gridsize-i;++j){
                        heatmap_grids[t].style.background = 'rgb('
                            +color[t][0]+','+color[t][1]+','+color[t][2]+')';
                        t += 1;
                    }
                }
            }

            // Next update the rootsinfo
            if (findroot == 1){
                document.getElementById("rootsinfo").innerHTML = '';
                axios.post('http://127.0.0.1:5000/process/rootangents',{}
                ).then(res => {
                    {
                        let str = res.data.rootsinfo;
                        // /n -> <br>
                        let i = 0;
                        while (i < str.length){
                            if (str[i] == '\n'){
                                str = str.slice(0, i) + ' <br> ' + str.slice(i+1, str.length);
                                i += 5;
                            }
                            ++i;
                        }
                        document.getElementById("rootsinfo").innerHTML = str;
                    }
                    {
                        let str = res.data.tangents;
                        document.getElementById("input_tangents").value = str.join('\n');
                    }

                    if (sos !== null){
                        // 同时还要进行配方
                        sos();
                    }
                }).catch(err => {
                    if (sos !== null){
                        sos_work.num -= 1;
                        if (sos_work.num == 0){
                            document.getElementById("sumofsquare").innerHTML = "Sum of Square";
                        }else{
                            document.getElementById("sumofsquare").innerHTML = "Sum of Square (" + sos_work.num + ")";
                        }
                    }
                });

            }
        }).catch(err => {
            if (sos !== null){
                sos_work.num -= 1;
                if (sos_work.num == 0){
                    document.getElementById("sumofsquare").innerHTML = "Sum of Square";
                }else{
                    document.getElementById("sumofsquare").innerHTML = "Sum of Square (" + sos_work.num + ")";
                }
            }
        }) ;
    };

    
    function SumOfSquare(){
        document.getElementById("sumofsquare").blur();
        sos_work.num += 1;
        document.getElementById("sumofsquare").innerHTML = "Sum of Square (" + sos_work.num + ")";
        
        function SOS_callback(){
            const input_poly = document.getElementById('input_poly').value;
            const tangents = document.getElementById('input_tangents').value;
            const use_structural_method = document.getElementById("setting_use_structural_method").checked;
            axios.post('http://127.0.0.1:5000/process/sos',{
                poly: input_poly, tangents: tangents, use_structural_method: use_structural_method}
            ).then(res=>{
                sos_results.latex = res.data.latex; 
                sos_results.txt   = res.data.txt;
                sos_results.formatted = res.data.formatted;
                document.getElementById('output_result').innerHTML = res.data[sos_results.show]

                const shadow_box = document.getElementById("shadow_box");
                let past;
                if ((past = shadow_box.firstChild)){
                    past.remove();
                }
                
                let str;
                if (!res.data.success){
                    str = '\\quad\\quad\\quad{\\rm Failed}\\quad\\quad\\quad';
                }else{
                    const text_length = sos_results.latex.length;
                    str = sos_results.latex.slice(2, text_length-2);
                    if (str.indexOf('aligned') < 0){ // no aligned environment
                        if (str.indexOf('\\\\') >= 0){
                            // 存在换行, 使用 \begin{aligned}
                            let i = 0;
                            while (i+1 < str.length){
                                if (str[i] == '\\' && str[i+1] == '\\'){
                                    str = str.slice(0, i+2) + ' & ' + str.slice(i+2, str.length);
                                    i += 2;        
                                }
                                ++i;
                            }
                            str = '\\begin{aligned}  \\  &' + str + '\\end{aligned}';
                        }
                    }
                }
                
                sos_work.num -= 1;
                if (sos_work.num == 0){
                    document.getElementById("sumofsquare").innerHTML = "Sum of Square";
                }else{
                    document.getElementById("sumofsquare").innerHTML = "Sum of Square (" + sos_work.num + ")";
                }

                let svg = window.MathJax.tex2svg(str).children[0];
                // shadow_box.style.height = '80%';
                shadow_box.appendChild(svg);
                svg.setAttribute('style', 'width: 95%; height: 90%; margin-top: 2%'); 
                shadow_box.hidden = "";
                document.getElementById("shadow").hidden = "";
                document.getElementById("input_poly").blur();
                document.getElementById("input_tangents").blur();
                sos_results.displaying = 1;
            }
            ).catch(err=>{
                sos_work.num -= 1;
                if (sos_work.num == 0){
                    document.getElementById("sumofsquare").innerHTML = "Sum of Square";
                }else{
                    document.getElementById("sumofsquare").innerHTML = "Sum of Square (" + sos_work.num + ")";
                }
            });
        }
        preprocessInput({findroot: 1, sos: SOS_callback});
    }


    function ChangeShowType(x){
        if (sos_results.show != x){
            document.getElementById('output_show' + sos_results.show).style.color = 'black';
            document.getElementById('output_show' + sos_results.show).style.border = 'none';
            sos_results.show = x;
            document.getElementById('output_show' + x).style.color = 'rgb(41,50,225)';
            document.getElementById('output_show' + x).style.borderBottom = '2px solid blue';
            document.getElementById('output_result').innerHTML = sos_results[x];
        }else if (x == 'latex'){ // == sos_results.show
            document.getElementById("shadow_box").hidden = "";
            document.getElementById("shadow").hidden = "";
            sos_results.displaying = 1;
        }
    }


    function ChangeShowTypeHover(x, event){
        // event == 0: mouseenter    event == 1: mouseleave
        if (sos_results.show != x){
            if (event == 0){
                document.getElementById('output_show' + x).style.color = 'rgb(19,135,245)';
            }else{
                document.getElementById('output_show' + x).style.color = 'black';
            }
        }
    }


    function PolyTools(event){
        if ((event === 'rotate') || (event === 'rotate_reflect') || (event === 'reflect')){
            const input_poly_box = document.getElementById('input_poly');
            let txt = input_poly_box.value;
            let result = [];
            if (event === 'rotate'){
                for (let i = 0, n = txt.length; i < n; ++i){
                    if (txt[i] === 'a') result.push('b');
                    else if (txt[i] === 'b') result.push('c');
                    else if (txt[i] === 'c') result.push('a');
                    else result.push(txt[i]);
                }
            }else if (event === 'rotate_reflect'){
                for (let i = 0, n = txt.length; i < n; ++i){
                    if (txt[i] === 'a') result.push('c');
                    else if (txt[i] === 'b') result.push('a');
                    else if (txt[i] === 'c') result.push('b');
                    else result.push(txt[i]);
                }
            }else if (event === 'reflect'){
                for (let i = 0, n = txt.length; i < n; ++i){
                    if (txt[i] === 'b') result.push('a');
                    else if (txt[i] === 'a') result.push('b');
                    else result.push(txt[i]);
                }
            }
            input_poly_box.value = result.join("");
            preprocessInput({findroot: 1});
        }else if (event === 'factor'){
            sos_poly = ''; // reset
            preprocessInput({findroot: 1, factor: true});
        }
    }

    document.onkeyup = function(e) {
        // 兼容FF和IE和Opera
        var event = e || window.event;
        var key = event.which || event.keyCode || event.charCode;
        if ((key == 13 || key == 27) & sos_results.displaying == 1){
            // is displaying
            sos_results.displaying = 0; 
            // document.getElementById("shadow_box").hidden = "hidden";
            document.getElementById("shadow").hidden = "hidden";
        }
    };
</script>
</html>